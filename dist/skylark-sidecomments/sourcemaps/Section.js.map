{"version":3,"sources":["Section.js"],"names":["define","langx","$","Template","CommentTemplate","mobileCheck","Section","eventPipe","$el","currentUser","comments","this","clickEventName","id","data","on","proxy","markerClick","addCommentClick","postCommentClick","cancelCommentClick","deleteCommentClick","render","prototype","event","preventDefault","select","showCommentForm","emit","length","find","addClass","focusCommentBox","hideCommentForm","removeClass","empty","setTimeout","get","focus","cancelComment","deselect","postComment","$commentBox","commentBody","val","comment","sectionId","authorAvatarUrl","avatarUrl","authorName","name","authorId","authorUrl","insertComment","push","newCommentHtml","template","append","updateCommentCount","text","commentId","target","closest","window","confirm","deleteComment","removeComment","filter","remove","isSelected","hasClass","sectionClasses","classes","commentTemplate","appendTo","destroy","off"],"mappings":"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","file":"../Section.js","sourcesContent":["\ndefine([\n\t\"skylark-langx/langx\",\n\t\"skylark-jquery\",\n\t\"../templates/section.html\",\n\t\"./templates/comment.html\",\n\t\"./helpers/mobile-check\"\n],function(langx,$,Template,CommentTemplate,mobileCheck){\n\n\t/**\n\t * Creates a new Section object, which is responsible for managing a\n\t * single comment section.\n\t * @param {Object} eventPipe The Emitter object used for passing around events.\n\t * @param {Array} comments   The array of comments for this section. Optional.\n\t */\n\tfunction Section( eventPipe, $el, currentUser, comments ) {\n\t\tthis.eventPipe = eventPipe;\n\t\tthis.$el = $el;\n\t\tthis.comments = comments ? comments.comments : [];\n\t\tthis.currentUser = currentUser || null;\n\t\tthis.clickEventName = mobileCheck() ? 'touchstart' : 'click';\n\t\t\n\t\tthis.id = $el.data('section-id');\n\n\t\tthis.$el.on(this.clickEventName, '.side-comment .marker', langx.proxy(this.markerClick, this));\n\t\tthis.$el.on(this.clickEventName, '.side-comment .add-comment', langx.proxy(this.addCommentClick, this));\n\t\tthis.$el.on(this.clickEventName, '.side-comment .post', langx.proxy(this.postCommentClick, this));\n\t\tthis.$el.on(this.clickEventName, '.side-comment .cancel', langx.proxy(this.cancelCommentClick, this));\n\t\tthis.$el.on(this.clickEventName, '.side-comment .delete', langx.proxy(this.deleteCommentClick, this));\n\t\tthis.render();\n\t}\n\n\t/**\n\t * Click callback event on markers.\n\t * @param  {Object} event The event object.\n\t */\n\tSection.prototype.markerClick = function( event ) {\n\t\tevent.preventDefault();\n\t\tthis.select();\n\t};\n\n\t/**\n\t * Callback for the comment button click event.\n\t * @param {Object} event The event object.\n\t */\n\tSection.prototype.addCommentClick = function( event ) {\n\t  event.preventDefault();\n\t  if (this.currentUser) {\n\t  \tthis.showCommentForm();\n\t  } else {\n\t  \tthis.eventPipe.emit('addCommentAttempted');\n\t  }\n\t};\n\n\t/**\n\t * Show the comment form for this section.\n\t */\n\tSection.prototype.showCommentForm = function() {\n\t  if (this.comments.length > 0) {\n\t    this.$el.find('.add-comment').addClass('hide');\n\t    this.$el.find('.comment-form').addClass('active');\n\t  }\n\n\t  this.focusCommentBox();\n\t};\n\n\t/**\n\t * Hides the comment form for this section.\n\t */\n\tSection.prototype.hideCommentForm = function() {\n\t  if (this.comments.length > 0) {\n\t    this.$el.find('.add-comment').removeClass('hide');\n\t    this.$el.find('.comment-form').removeClass('active');\n\t  }\n\n\t  this.$el.find('.comment-box').empty();\n\t};\n\n\t/**\n\t * Focus on the comment box in the comment form.\n\t */\n\tSection.prototype.focusCommentBox = function() {\n\t\t// NOTE: !!HACK!! Using a timeout here because the autofocus causes a weird\n\t\t// \"jump\" in the form. It renders wider than it should be on screens under 768px\n\t\t// and then jumps to a smaller size.\n\t\tsetTimeout(langx.proxy(function(){\n\t\t\tthis.$el.find('.comment-box').get(0).focus();\n\t\t}, this), 300);\n\t};\n\n\t/**\n\t * Cancel comment callback.\n\t * @param  {Object} event The event object.\n\t */\n\tSection.prototype.cancelCommentClick = function( event ) {\n\t  event.preventDefault();\n\t  this.cancelComment();\n\t};\n\n\t/**\n\t * Cancel adding of a comment.\n\t */\n\tSection.prototype.cancelComment = function() {\n\t  if (this.comments.length > 0) {\n\t    this.hideCommentForm();\n\t  } else {\n\t  \tthis.deselect();\n\t    this.eventPipe.emit('hideComments');\n\t  }\n\t};\n\n\t/**\n\t * Post comment callback.\n\t * @param  {Object} event The event object.\n\t */\n\tSection.prototype.postCommentClick = function( event ) {\n\t  event.preventDefault();\n\t  this.postComment();\n\t};\n\n\t/**\n\t * Post a comment to this section.\n\t */\n\tSection.prototype.postComment = function() {\n\t\tvar $commentBox = this.$el.find('.comment-box');\n\t  var commentBody = $commentBox.val();\n\t  var comment = {\n\t  \tsectionId: this.id,\n\t  \tcomment: commentBody,\n\t  \tauthorAvatarUrl: this.currentUser.avatarUrl,\n\t  \tauthorName: this.currentUser.name,\n\t  \tauthorId: this.currentUser.id,\n\t  \tauthorUrl: this.currentUser.authorUrl || null\n\t  };\n\t  $commentBox.val(''); // Clear the comment.\n\t  this.eventPipe.emit('commentPosted', comment);\n\t};\n\n\t/**\n\t * Insert a comment into this sections comment list.\n\t * @param  {Object} comment A comment object.\n\t */\n\tSection.prototype.insertComment = function( comment ) {\n\t\tthis.comments.push(comment);\n\t\tvar newCommentHtml = langx.template(CommentTemplate)({ \n\t\t\tcomment: comment,\n\t\t\tcurrentUser: this.currentUser\n\t\t});\n\t\tthis.$el.find('.comments').append(newCommentHtml);\n\t\tthis.$el.find('.side-comment').addClass('has-comments');\n\t\tthis.updateCommentCount();\n\t\tthis.hideCommentForm();\n\t};\n\n\t/**\n\t * Increments the comment count for a given section.\n\t */\n\tSection.prototype.updateCommentCount = function() {\n\t\tthis.$el.find('.marker span').text(this.comments.length);\n\t};\n\n\t/**\n\t * Event handler for delete comment clicks.\n\t * @param  {Object} event The event object.\n\t */\n\tSection.prototype.deleteCommentClick = function( event ) {\n\t\tevent.preventDefault();\n\t\tvar commentId = $(event.target).closest('li').data('comment-id');\n\n\t\tif (window.confirm(\"Are you sure you want to delete this comment?\")) {\n\t\t\tthis.deleteComment(commentId);\n\t\t}\n\t};\n\n\t/**\n\t * Finds the comment and emits an event with the comment to be deleted.\n\t */\n\tSection.prototype.deleteComment = function( commentId ) {\n\t\tvar comment = langx.find(this.comments, function(comment) {\n\t\t\treturn comment.id == commentId ;\n\t\t});\n\t\tcomment.sectionId = this.id;\n\t\tthis.eventPipe.emit('commentDeleted', comment);\n\t};\n\n\t/**\n\t * Removes the comment from the list of comments and the comment array.\n\t * @param commentId The ID of the comment to be removed from this section.\n\t */\n\tSection.prototype.removeComment = function( commentId ) {\n\t\tthis.comments = langx.filter(this.comments, function(comment) {\n\t\t\treturn comment.id != commentId ;\n\t\t});\n\n\t\tthis.$el.find('.side-comment .comments li[data-comment-id=\"'+commentId+'\"]').remove();\n\t\tthis.updateCommentCount();\n\t\tif (this.comments.length < 1) {\n\t\t\tthis.$el.find('.side-comment').removeClass('has-comments');\n\t\t}\n\t};\n\n\t/**\n\t * Mark this section as selected. Delsect if this section is already selected.\n\t */\n\tSection.prototype.select = function() {\n\t\tif (this.isSelected()) {\n\t\t\tthis.deselect();\n\t\t\tthis.eventPipe.emit('sectionDeselected', this);\n\t\t} else {\n\t\t\tthis.$el.find('.side-comment').addClass('active');\n\n\t\t\tif (this.comments.length === 0 && this.currentUser) {\n\t\t\t  this.focusCommentBox();\n\t\t\t}\n\n\t\t\tthis.eventPipe.emit('sectionSelected', this);\n\t\t}\n\t};\n\n\t/**\n\t * Deselect this section.\n\t */\n\tSection.prototype.deselect = function() {\n\t\tthis.$el.find('.side-comment').removeClass('active');\n\t\tthis.hideCommentForm();\n\t};\n\n\tSection.prototype.isSelected = function() {\n\t\treturn this.$el.find('.side-comment').hasClass('active');\n\t};\n\n\t/**\n\t * Get the class to be used on the side comment section wrapper.\n\t * @return {String} The class names to use.\n\t */\n\tSection.prototype.sectionClasses = function() {\n\t\tvar classes = '';\n\n\t\tif (this.comments.length > 0) {\n\t\t\tclasses = classes + ' has-comments';\n\t\t}\n\t\tif (!this.currentUser) {\n\t\t\tclasses = classes + ' no-current-user'\n\t\t}\n\n\t\treturn classes;\n\t};\n\n\t/**\n\t * Render this section into the DOM.\n\t */\n\tSection.prototype.render = function() {\n\t\tthis.$el.find('.side-comment').remove();\n\t\t$(langx.template(Template,{\n\t\t  commentTemplate: CommentTemplate,\n\t\t  comments: this.comments,\n\t\t  sectionClasses: this.sectionClasses(),\n\t\t  currentUser: this.currentUser\n\t\t})).appendTo(this.$el);\n\t};\n\n\t/**\n\t * Desttroy this Section object. Generally meaning unbind events.\n\t */\n\tSection.prototype.destroy = function() {\n\t\tthis.$el.off();\n\t}\n\n\treturn Section;\n\n});\n"]}